{% extends 'index.html' %}
<!-- C -->
{% load static %}
<!-- C -->
{% block extra_css %}
<link rel="stylesheet" href="{% static './pdf_manager/styles.css' %}" />
{% endblock %}
<!-- C -->
{% block content %}
<h2>Combine PDFs</h2>

<form id="combineForm" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <p>
        <label for="id_pdf_files">Upload PDFs:</label><br />
        <input type="file" name="pdf_files" id="id_pdf_files" multiple required />
    </p>

    <p>
        <label>
            <input type="checkbox" name="add_bookmarks" />
            Add bookmarks from filenames?
        </label>
    </p>

    <button type="submit">Combine</button>
</form>

<div id="msg" role="status" style="max-width: 600px; margin: 12px auto; text-align: center"></div>

<script>
    // helper: get csrftoken from cookie (Django default)
    function getCookie(name) {
        const v = document.cookie.match("(^|;)\\s*" + name + "\\s*=\\s*([^;]+)");
        return v ? v.pop() : "";
    }

    const form = document.getElementById("combineForm");
    const msg = document.getElementById("msg");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "Processing...";
        const fd = new FormData(form);

        try {
            const resp = await fetch(form.action || window.location.href, {
                method: "POST",
                headers: { "X-CSRFToken": getCookie("csrftoken") },
                body: fd,
            });

            if (!resp.ok) {
                const text = await resp.text();
                msg.textContent = "Server error. See console for details.";
                console.error("Server response (not ok):", resp.status, text);
                return;
            }

            // Get filename from Content-Disposition header if present
            const cd = resp.headers.get("Content-Disposition") || "";
            let filename = "combined.pdf";
            const m = cd.match(/filename\*?=(?:UTF-8'')?"?([^";]+)"?/);
            if (m) filename = decodeURIComponent(m[1]);

            // Read the response as a blob and trigger download
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            // Reset form and show success
            form.reset();
            msg.textContent = "âœ… Combined PDF downloaded and form reset.";
            setTimeout(() => {
                msg.textContent = "";
            }, 3000);
        } catch (err) {
            console.error(err);
            msg.textContent = "Network error. See console for details.";
        }
    });
</script>
{% endblock %}
