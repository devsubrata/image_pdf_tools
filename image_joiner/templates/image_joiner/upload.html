{% extends 'index.html' %}
<!-- C -->
{% load static %}
<!-- C -->
{% block title %}Join Images{% endblock %}

<!-- C -->
{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="{% static './image_joiner/styles.css' %}" />
{% endblock %}

<!-- C -->
{% block content %}
<div class="container mt-4" style="max-width: 1000px">
    <h2 class="mb-4 text-center">Upload Images to Join Vertically or Create PDF</h2>

    <form method="post" enctype="multipart/form-data" class="joiner-form p-4 rounded shadow">
        {% csrf_token %}
        <!-- Hidden file input -->
        <input type="file" name="images" id="fileInput" multiple accept="image/*" style="display: none" />

        <!-- Upload Button -->
        <div class="text-center mb-3">
            <button type="button" id="uploadBtn" class="btn btn-primary btn-lg"><i class="bi bi-upload"></i> Select Images</button>
        </div>

        <!-- Drop Zone -->
        <div id="dropZone" class="p-4 rounded mb-3 text-center">Drag & Drop files here or click to select</div>

        <!-- File count & list -->
        <div id="fileInfo" class="mb-3">
            <h5 id="fileCount" class="text-center"></h5>
            <div id="fileList" class="list-group"></div>
        </div>

        <!-- Conversion Options -->
        <div class="radio-button-group justify-content-center mb-3" style="display: none">
            <div class="radio-btn mx-2"><input value="images_to_image" type="radio" name="image-pdf" id="images_to_image" /> Images to Image</div>
            <div class="radio-btn mx-2"><input value="images_to_pdf" type="radio" name="image-pdf" id="images_to_pdf" /> Images to PDF</div>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
            <button type="submit" id="joinBtn" class="btn btn-success btn-lg" style="display: none">
                <i class="bi bi-arrow-right-square"></i> Join
            </button>
        </div>
    </form>

    <!-- Result Display -->
    {% if joined_image_url or joined_pdf_url %}
    <div id="display" class="mt-4 p-4 rounded shadow text-center">
        <button class="btn btn-warning mb-3" onclick="clearDisplay()"><i class="bi bi-x-circle"></i> Clear</button>

        {% if joined_image_url %}
        <h3>Joined Image</h3>
        <a href="{{ joined_image_url }}" download="joined_image.jpg" class="btn btn-outline-secondary mb-3">
            <i class="bi bi-download"></i> Download Image
        </a>
        <img src="{{ joined_image_url }}" alt="Joined Image" class="img-fluid rounded" />
        {% endif %} {% if joined_pdf_url %}
        <h3 class="mt-3">Created PDF</h3>
        <a href="{{ joined_pdf_url }}" target="_blank" class="btn btn-outline-secondary"> <i class="bi bi-file-earmark-pdf"></i> Download PDF </a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Error Message -->
    {% if error_message %}
    <div class="alert alert-danger mt-3 text-center" role="alert">{{ error_message }}</div>
    {% endif %}
</div>

<script>
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");
    const fileCount = document.getElementById("fileCount");
    const fileList = document.getElementById("fileList");
    const joinBtn = document.getElementById("joinBtn");
    const radioBtnsDiv = document.querySelector(".radio-button-group");
    const dropZone = document.getElementById("dropZone");

    uploadBtn.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("click", () => fileInput.click());

    // Drag & Drop effects
    ["dragenter", "dragover"].forEach((evt) => {
        dropZone.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add("highlight");
        });
    });
    ["dragleave", "drop"].forEach((evt) => {
        dropZone.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove("highlight");
        });
    });

    // Handle files
    fileInput.addEventListener("change", () => handleFiles(fileInput.files));
    dropZone.addEventListener("drop", (e) => {
        const files = e.dataTransfer.files;
        fileInput.files = files;
        handleFiles(files);
    });

    function handleFiles(files) {
        if (files.length > 0) {
            let listHtml = "";
            for (let f of files) {
                listHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${f.name}</span>
                            <span class="badge bg-primary rounded-pill">${(f.size / 1024).toFixed(1)} KB</span>
                         </li>`;
            }
            fileList.innerHTML = listHtml;
            fileCount.textContent = `${files.length} file${files.length > 1 ? "s" : ""} selected`;
            joinBtn.style.display = "inline-block";
            radioBtnsDiv.style.display = "flex";
        } else {
            fileList.innerHTML = "";
            fileCount.textContent = "";
            joinBtn.style.display = "none";
            radioBtnsDiv.style.display = "none";
        }
    }

    function clearDisplay() {
        const displaySection = document.querySelector("#display");
        if (displaySection) displaySection.remove();
    }
</script>
{% endblock %}
